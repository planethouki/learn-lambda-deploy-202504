# AWS Lambda Learn

Python 3.11で実装されたAWS Lambda関数のサンプルプロジェクトです。Serverless Frameworkを使用してデプロイします。コンテナイメージを使用してLambda関数を実行します。

## 概要

このプロジェクトには、3つのシンプルなLambda関数が含まれています：

1. **hello** - 基本的な挨拶メッセージを返します
2. **hoge** - ランダムな数値とともにメッセージを返します
3. **fuga** - ユニークIDとともにメッセージを返します

## 前提条件

- Node.js (v14以上)
- npm (v6以上)
- Python 3.11
- Docker (最新版)
- AWS CLI (設定済み)
- AWS認証情報（アクセスキーとシークレットキー）

## セットアップ

1. 依存関係をインストールします：

```bash
npm install
```

2. Dockerが正しく設定されていることを確認します：

```bash
docker --version
```

## デプロイ

### コンテナイメージを使用したデプロイ

AWS環境にコンテナイメージとしてデプロイするには：

```bash
npm run deploy
```

特定の関数だけをデプロイするには：

```bash
npm run deploy:function -- --function hello
```

### デプロイプロセスの説明

デプロイ時に以下のステップが実行されます：

1. Dockerfileからコンテナイメージがビルドされます
2. イメージがAWS ECR（Elastic Container Registry）にプッシュされます
3. Lambda関数がコンテナイメージを使用して作成/更新されます

### 初回デプロイ時の注意点

初回デプロイ時には、ECRリポジトリが自動的に作成されます。AWSアカウントに対して適切な権限（ECRリポジトリの作成権限など）が必要です。

## 削除

デプロイしたリソースを削除するには：

```bash
npm run remove
```

## エンドポイント

デプロイ後、以下のエンドポイントが利用可能になります：

- `GET /hello` - Hello関数
- `GET /hoge` - Hoge関数
- `GET /fuga` - Fuga関数

実際のURLはデプロイ後に表示されます。

## コンテナ化の理由

このプロジェクトでは、以下の理由からLambda関数をコンテナとして実行しています：

1. **複雑な依存関係の管理** - Symbol SDKなどの複雑な依存関係を持つライブラリを使用しているため
2. **環境の一貫性** - 開発環境と本番環境の一貫性を確保するため
3. **カスタムランタイム環境** - 特定のバイナリや設定が必要な場合に対応するため

## トラブルシューティング

### デプロイエラー

- **ECRへのプッシュに失敗する場合** - AWS認証情報が正しく設定されていることを確認してください
- **イメージビルドに失敗する場合** - Dockerが正しくインストールされ、実行されていることを確認してください
- **Lambda関数の実行に失敗する場合** - CloudWatchログを確認して詳細なエラーメッセージを確認してください

### ローカルでのテスト

コンテナをローカルでテストするには：

```bash
# イメージをビルド
docker build -t lambda-local .

# ローカルでLambda関数をシミュレート
docker run -p 9000:8080 lambda-local

# 別のターミナルから関数を呼び出し
curl -XPOST "http://localhost:9000/2015-03-31/functions/function/invocations" -d '{}'
```
